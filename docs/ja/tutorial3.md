# チュートリアル(3): graph モジュール

ペンシルパズルでは，「白マスが一つながりになる」「盤面に単一のループができる」といったルールがしばしば登場します．
このような条件を毎回 CSP で 1 から記述するのは面倒ですが，cspuz の `graph` モジュールを用いると，こういった制約を簡単に記述することができます．

## graph とは？

`graph` は「白マスが一つながり」といった条件を記述できるモジュールですが，より一般の「グラフ」に対して同様の条件を記述することもできます．
（詳細はソースコードを読んでください）
以下，その理論的背景について記述します．（読み飛ばして構いません）

---

グラフ (graph) は，「棒グラフ」や「折れ線グラフ」などのグラフではなく，数学の [グラフ理論](https://ja.wikipedia.org/wiki/%E3%82%B0%E3%83%A9%E3%83%95%E7%90%86%E8%AB%96) の用語で，**頂点** と，2 つの頂点を結ぶ **辺** たちからなる構造を言います．

ペンシルパズルにおける「白マスは一つながりになる」といった条件は，次のようにするとグラフ理論的に抽象化することができます：

- 盤面の各マスを頂点，隣り合っているマス（に対応する頂点）同士が辺で結ばれたグラフを考える
- このグラフにおいて，白マスに対応する頂点のみからなる誘導部分グラフが連結

「白マスが一つながり」という制約は，内部的にはこのような制約として解釈されて CSP に変換されています．正確には，前章の `Array` を与えたときには，自然なグラフ構造を自動で用いるようになっています．ここで，直接グラフ構造を与えて制約を記述することも可能になっています．こうすることで，例えば三角形のマス目上での連結条件なども記述できるようになっています．

## 盤面全体で連結

「白マスが一つながり」といった条件を記述するには，`graph.active_vertices_connected` を用いることができます．

```
graph.active_vertices_connected(solver, is_active, acyclic=False)
```

（注：前節で述べたように，`graph` モジュールの関数は一般のグラフを与えて利用することも可能ですが，ここではそのような利用法については割愛するため，省略した引数が存在します）

- `solver` は，制約を加える対象の `Solver` オブジェクトです．
- `is_active` は論理値型の 2 次元 `Array` です．これを自然に 2 次元グリッドとして解釈し，値が true のマスが一つながりになっていることを制約として加えます．
- `acyclic` が `True` であるならば，一つながりであるだけでなく，「輪っかができない」（値が true のマスからそのマス自身まで，true のマスだけを通って，同じマスを 2 度通らないようにたどることができない）ことも制約とします．

### 使用例

[クリークソルバー](../../cspuz/puzzle/creek.py) で，白マスが連結という制約を記述するために `graph.active_vertices_connected` を使用しています．

## 連黒分断禁

「黒マスが隣接しない」という条件を書く関数も存在します：

```
graph.active_vertices_not_adjacent(solver, is_active)
```

- `solver` は，制約を加える対象の `Solver` オブジェクトです．
- `is_active` は論理値型の 2 次元 `Array` です．値が true であるマスを黒マスに見立てて，黒マスが隣接しないという条件を制約として加えます．

ちなみに，この制約は，Array の要素同士の演算を使うと 2 行で書くこともできます：
```
solver.ensure(~(is_active[1:, :] & is_active[:-1, :]))
solver.ensure(~(is_active[:, 1:] & is_active[:, :-1]))
```

これと先程の `active_vertices_connected` と組み合わせて，いわゆる「連黒分断禁」制約を書くことができます．

一方，連黒分断禁については直接書くための関数も存在します：

```
graph.active_vertices_not_adjacent_and_not_segmenting(solver, is_active)
```

- `solver` は，制約を加える対象の `Solver` オブジェクトです．
- `is_active` は論理値型の 2 次元 `Array` です．値が true であるマスを黒マス，false であるマスを白マスに見立てて，連黒分断禁条件（すなわち，黒マスが隣接しない，かつ白マスが黒マスで分断されない，という条件）を制約として加えます．

なお，これは `active_vertices_connected` を用いる方法とは CSP への変換方法が違うので，完全に等価ではないですが，同様のものと思ってかまいません．

### 使用例

[へやわけソルバー](../../cspuz/puzzle/heyawake.py) を見てください．
